window.AudioContext = window.AudioContext || window.webkitAudioContext;
var audioContext = new AudioContext();
var audioInput = null,
    inputPoint = null;
var rafID = null;
var analyserContext = null;
var canvasWidth, canvasHeight;
var logPitch = true;
var Note = null;

// TODO normlize freqData -1 to 1 instead of 0 to 256
var testArr = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,11,11,11,11,11,11,11,11,11,11,11,12,12,12,12,12,12,12,12,12,12,12,12,13,13,13,13,13,13,13,13,13,13,13,13,14,14,14,14,14,14,14,14,14,14,15,15,15,15,15,15,15,15,15,15,15,16,16,16,16,16,16,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,25,25,25,25,25,25,26,26,26,26,26,26,26,27,27,27,27,27,27,28,28,28,28,28,28,29,29,29,29,29,29,30,30,30,30,30,30,30,31,31,31,31,31,31,32,32,32,32,32,32,33,33,33,33,33,33,34,34,34,34,34,34,35,35,35,35,35,35,36,36,36,36,36,36,37,37,37,37,37,37,38,38,38,38,38,38,39,39,39,39,39,39,40,40,40,40,40,41,41,41,41,41,42,42,42,42,43,43,43,43,44,44,44,44,44,44,45,45,45,45,45,45,46,46,46,46,46,46,47,47,47,47,48,48,48,48,48,49,49,49,49,50,50,50,50,51,51,51,51,51,51,52,52,52,52,52,53,53,53,54,54,54,54,55,55,55,55,55,55,56,56,56,56,56,57,57,57,58,58,58,58,59,59,59,59,59,59,60,60,60,60,60,61,61,62,62,62,62,62,63,63,63,63,63,63,63,64,64,65,65,65,65,66,66,66,66,66,66,67,67,67,67,68,68,69,69,69,69,69,69,70,70,70,70,70,71,71,71,71,71,71,72,72,72,72,73,73,73,74,74,74,74,74,74,75,75,75,75,76,76,76,77,77,77,77,77,77,77,78,78,79,79,79,79,80,80,80,80,80,80,81,81,82,82,82,82,82,82,83,83,83,83,84,84,84,85,85,85,85,85,85,85,86,86,87,87,87,87,87,88,88,88,88,88,89,89,90,90,91,91,91,91,91,91,91,92,92,92,92,92,92,93,93,93,93,94,94,94,94,95,95,95,95,95,95,95,96,97,97,97,97,97,97,97,97,98,98,99,99,99,99,99,99,100,100,100,100,100,101,101,101,101,102,102,102,102,102,102,102,103,103,104,104,104,104,104,104,104,104,104,106,106,106,106,106,106,106,106,106,107,107,107,108,108,108,108,108,108,108,109,109,109,109,110,110,110,110,110,110,110,111,111,111,111,111,111,112,112,112,112,112,113,113,113,113,113,113,113,114,114,114,114,114,115,115,115,115,115,115,115,115,115,116,116,116,117,117,117,117,117,117,117,117,117,117,117,117,118,118,119,119,119,119,119,119,119,119,119,119,119,119,119,119,119,120,121,121,121,121,121,121,121,121,121,121,121,121,121,121,121,121,121,121,122,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,122,121,121,121,121,121,121,121,121,121,121,121,121,121,121,121,121,121,121,120,119,119,119,119,119,119,119,119,119,119,119,119,119,119,119,118,118,117,117,117,117,117,117,117,117,117,117,117,117,116,116,116,115,115,115,115,115,115,115,115,115,114,114,114,114,114,113,113,113,113,113,113,113,112,112,112,112,112,111,111,111,111,111,111,110,110,110,110,110,110,110,109,109,109,109,108,108,108,108,108,108,108,107,107,107,106,106,106,106,106,106,106,106,106,104,104,104,104,104,104,104,104,104,103,103,102,102,102,102,102,102,102,101,101,101,101,100,100,100,100,100,99,99,99,99,99,99,98,98,97,97,97,97,97,97,97,97,96,95,95,95,95,95,95,95,94,94,94,94,93,93,93,93,92,92,92,92,92,92,91,90,90,90,90,90,90,90,90,89,89,88,88,88,88,88,87,87,87,87,87,86,86,85,85,85,85,85,85,85,84,84,84,83,83,83,83,82,82,82,82,82,82,81,81,80,80,80,80,80,80,79,79,79,79,78,78,77,77,77,77,77,77,77,76,76,76,75,75,75,75,74,74,74,74,74,74,73,73,73,72,72,72,72,71,71,71,71,71,71,70,70,70,69,69,69,68,68,68,68,68,68,68,67,67,67,66,66,66,65,65,65,65,65,65,64,64,64,64,63,63,63,62,62,62,62,62,61,61,61,61,61,61,60,60,60,59,59,59,59,58,58,58,58,58,58,57,57,57,57,57,56,56,56,55,55,55,55,54,54,54,54,54,54,53,53,53,53,53,52,52,52,52,51,51,51,50,50,50,50,50,50,49,49,49,49,49,49,48,48,48,48,48,47,47,47,47,46,46,46,46,45,45,45,45,45,44,44,44,44,44,44,43,43,43,43,43,43,42,42,42,42,42,41,41,41,41,41,40,40,40,40,39,39,39,39,39,38,38,38,38,38,37,37,37,37,37,37,36,36,36,36,36,36,35,35,35,35,35,35,34,34,34,34,34,34,33,33,33,33,33,33,32,32,32,32,32,32,31,31,31,31,31,31,30,30,30,30,30,30,30,29,29,29,29,29,29,28,28,28,28,28,28,27,27,27,27,27,27,26,26,26,26,26,26,26,25,25,25,25,25,25,25,25,24,24,24,24,24,24,24,24,23,23,23,23,23,23,23,23,23,22,22,22,22,22,22,22,21,21,21,21,21,21,20,20,20,20,20,20,20,20,19,19,19,19,19,19,19,19,19,19,19,18,18,18,18,18,18,18,18,17,17,17,17,17,17,17,17,16,16,16,16,16,16,16,16,16,16,16,16,15,15,15,15,15,15,15,15,15,14,14,14,14,14,14,14,14,14,14,14,14,13,13,13,13,13,13,13,13,13,13,12,12,12,12,12,12,12,12,12,12,12,12,12,12,11,11,11,11,11,11,11,11,11,11,10,10,10,10,10,10,10,10,10,10,10,10,10,10,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
var testArr2 = [187,194,199,206,211,216,222,227,231,236,240,243,246,249,252,254,254,254,254,254,254,254,254,254,254,253,251,248,245,242,238,234,229,224,219,214,208,202,196,190,183,177,170,163,156,149,142,135,128,121,114,107,100,93,86,80,74,67,62,56,51,45,41,36,32,28,25,22,19,17,15,13,12,12,11,12,12,13,14,16,18,21,23,27,31,35,39,44,49,54,60,66,72,78,85,91,99,105,112,120,127,134,141,148,155,163,170,177,184,190,197,203,209,215,220,226,231,236,240,244,248,251,254,254,254,254,254,254,254,254,254,254,254,254,254,254,252,249,245,241,237,232,227,222,216,211,205,198,192,185,178,171,164,157,150,143,135,128,121,113,106,99,92,85,79,72,66,60,54,48,43,38,34,30,26,22,19,16,14,12,10,9,9,8,8,9,10,11,13,15,17,20,24,27,31,36,41,46,51,57,62,69,75,81,88,95,102,109,116,123,130,137,144,152,159,166,173,179,186,192,198,204,210,216,221,226,230,234,239,242,245,248,250,252,254,254,254,254,254,254,254,254,253,251,249,246,243,239,235,231,226,222,216,211,205,199,193,187,180,173,167,159,152,145,138,131,124,117,110,103,95,89,82,75,69,63,57,51,46,41,36,32,28,24,20,17,14,12,10,9,8,7,6,6,7,8,9,11,13,15,18,21,25,29,33,37,42,47,52,58,64,70,77,83,90,97,103,110,117,124,131,138,145,151,158,165,172,178,184,190,196,202,207,212,217,222,226,230,233,236,239,242,244,246,247,248,248,248,248,248,246,245,243,241,238,235,232,228,224,220,215,210,205,199,193,187,181,174,168,161,154,147,140,133,126,118,111,104,97,90,84,77,70,64,58,52,47,41,36,31,26,22,18,15,11,9,6,4,2,1,0,0,0,0,1,2,4,6,8,11,14,18,21,25,30,35,40,45,51,57,63,70,76,83,90,96,104,111,118,125,132,139,146,153,160,167,173,179,186,192,198,203,209,214,218,223,227,231,234,237,240,242,244,245,246,247,247,247,246,245,244,242,239,237,234,230,227,223,218,214,208,203,197,191,185,179,172,165,158,151,144,136,129,122,114,107,100,93,86,78,72,65,58,52,46,40,35,30,24,20,15,11,7,4,1,0,0,0,0,0,0,1,1,1,1,1,1,1,3,7,10,14,19,23,28,34,39,45,51,57,64,71,78,84,92,99,106,113,121,128,135,142,149,156,163,170,177,183,189,195,201,206,211,216,221,225,229,232,235,238,240,242,243,244,245,245,245,244,243,242,240,238,235,232,229,225,221,217,212,207,202,196,190,184,177,170,164,157,150,143,136,128,121,114,106,99,92,85,78,72,65,59,53,47,41,36,30,25,21,16,12,9,6,3,1,1,1,1,1,1,1,1,1,1,1,1,3,6,9,12,16,21,25,30,35,41,47,52,58,65,72,78,85,92,99,106,113,120,128,135,141,149,156,162,169,175,182,188,194,199,204,210,214,218,223,226,229,233,235,237,239,241,242,242,243,243,242,241,240,238,236,234,231,228,224,221,216,212,207,202,196,190,185,178,172,166,159,152,145,138,131,124,117,110,104,97,90,83,77,70,64,58,52,46,41,36,31,27,22,19,15,12,9,7,5,3,2,1,1,1,1,2,3,4,6,9,11,14,18,22,26,31,35,40,46,52,57,64,70,76,83,90,96,104,111,117,125,132,139,146,153,160,167,173,180,186,192,198,204,209,214,219,223,227,231,235,238,240,243,245,246,248,248,249,249,249,248,247,245,243,241,238,235,232,228,223,219,214,209,204,198,192,186,180,173,166,159,152,145,138,131,124,117,110,103,96,89,82,76,69,63,57,51,46,41,36,31,27,23,19,16,13,11,9,7,5,5,4,4,4,5,6,8,10,12,15,18,22,26,30,35,40,45,51,56,63,69,75,82,89,96,103,110,117,125,132,139,147,154,161,168,175,182,189,195,201,207,213,218,224,229,233,238,242,245,248,251,253,254,254,254,254,254,254,254,254,254,254,254,251,248,245,242,238,234,229,224,219,213,207,201,195,188,182,175,168,161,153,146,139,132,124,117,110,103,96,89,83,76,70,64,58,52,47,42,37,33,29,25,22,19,16,14,12,11,10,10,10,10,11,12,14,16,18,21,24,28,32,36,40,45,50,56,62,68,74,81,87,94,101,108,115,123,130,137,144,151,158,165,172,179,186,192,198,205,211,216,222,227,231,236,240,244,248,251,253,254,254,254,254,254,254,254,254,254,254,254,254,253,250,247,243,240,235,231,226,221,215,209,204,197,191,185,178,171,164,157,150,143,136,129,122,115,108,101,94,88,82,75,69,64,58,53,48,43,39,35,32,28,25,23,21,19,18,17,16,16,16,17,18,19,21,23,26,29,32,36,40,44,49,54,59,65,71,77,83,89,96,102,109,116,123,130,137,144,151,158,164,171,178,184,190,197,203,208,214,219,224,229,233,237,241,244,247,250,252,254,254,254,254,254,254,254,254,254,254,252,250,248,245,241,238,233,229,224,219,214,208,202,196,190,183,177,170,163,156,149,142,135,128,121,114,107,100,94,87,81,74,68,62,57,52,47,42,38,33,30,26,23,21,18,16,15,14,13,13,13,13,14,15,17,19,22,25,28,31,36,40,44,49,55,60,66,72,78,85,91,98,105,111,118,126,133,140,147,154,161,168,174,181,188,194,200,206,212,217,222,227,231,236,239,243,246,249,251,253,254,254,254,254,254,254,254,254,254,252,250,247,244,241,237,232,228,223,218,212,206,200,194,187,181,174,167,160,153,145,138,130,123,116,109,101,94,87,80,74,67,61,55,49,44,38,34,29,24,21,17,14,11,9,6,5,4,3,2,3,3,4,5,7,9,12,15,18,22,26,30,35,40,45,51,57,63,70,76,83,90,97,104,111,118,125,133,140,147,154,161,168,175,182,188,194,200,206,211,217,221,226,230,234,238,241,243,246,248,250,251,252,252,252,252,251,250,248,246,244,241,238,234,230,226,221,216,211,205,200,194,187,181,174,167,160,153,145,138,131,123,116,109,101,94,88,80,74,67,61,55,49,43,38,33,28,23,19,15,11,8,6,3,1,0,0,0,0,0,0,0,0,2,4,7,10,13,17,21,25,30,34,40,45,51,57,63,70,77,83,90,97,104,111,118,125,132,139,146,153,160,166,172,179,185,190,196,202,207,212,216,220,224,227,230,233,236,237,239,240,241,242,242,241,241,240,238,236,234,231,228,225,221,217,213,208,203,198,192,186,180,174,167,160,154,146,140,133,125,118,112,104,98,91,84,77,71,64,58,53,47,41,36,31,26,22,17,13,10,7,4,2,0,0,0,0,0,0,0,0,0,1,2,5,8,11,14,18,23,27,32,37,43,48,54,60,67,73,79,86,93,100,107,114,121,128,135,141,148,155,161,168,174,180,186,192,197,203,208,212,216,220,224,227,230,232,235,236,238,239,239,239,239,239,238,237,235,233,230,228,224,220,217,212,207,203,197,191,186,180,173,167,160,153,146,139,132,125,118,111,104,97,90,83,76,70,63,57,51,45,40,34,29,24,19,15,11,7,4,1,0,0,0,0,0,1,1,1,1,1,1,1,1,4,7,11,15,19,24,29,34,40,46,52,58,65,71,78,85,92,99,106,113,121,128,135,143,150,156,164,170,177,183,190,195,201,207,211,216,221,225,229,232,235,238,240,242,244,245,245,246,246,245,244,243,241,239,237,234,230,227,223,218,213,208,203,197,191,185,179,172,165,158,151,144,137,130,122,115,108,100,93,87,80,73,67,60,54,48,42,36,31,26,22,18,13,10,7,4,1,1,1,1,1,1,1,1,1,1,1,2,4,7,11,14,18,23,27,32,38,43,49,56,62,68,75,82,89,96,103,110,118,125,132,140,147,154,161,168,175,181,188,194,200,205,210,216,220,225,229,233,236,239,242,244,246,248,249,249,250,249,249,248,247,245,243,240,237,234,231,227,222,218,213,208,202,196,190,184,177,171,164,157,150,143,136,129,122,115,108,101,94,87,81,74,68,62,56,51,46,40,36,31,27,23,20,16,14,11,9,7,6,6,5,5,6,6,8,9,11,14,17,20,24,28,32,36,41,46,52,58,63,70,76,83,89,96,103,110,117,124,131,139,146,152,160,166,173,180,186,192,198,204,209,214,219,224,228,233,236,240,243,245,247,249,251,252,252,253,253,252,251,250,249,247,244,242,239,235,231,227,223,218,213,207,202,196,190,183,177,170,163,157,149,142,136,128,122,115,108,101,95,88,82,76,69,63,58,52,47,42,38,33,30,26,23,20,18,15,14,12,11,11,11,11,12,13,15,17,19,22,25,29,32,37,41,46,51,57,62,68,75,81,87,94,101,108,115,122,129,137,144,151,158,165,172,179,185,192,198,204,210,216,221,226,231,236,240,244,247,250,253,254,254,254,254,254,254,254,254,254,254,254,254,253,250,247,243,239,235,230,225,220,214,209,202,196,190,183,176,169,162,155,148,140,133,126,119,112,105,98,91,85,78,71,65,59,54,48,43,38,34,30,26,23,20,17,15,14,12,11,11,10,11,12,13,14,16,18,21,24,28];
var testArr3 = [110,106,104,103,103,104,105,107,110,112,113,114,114,113,111,109,106,102,99,97,96,96,97,99,102,106,111,115,120,124,127,129,130,129,128,126,124,121,118,116,114,113,113,113,114,115,116,117,118,118,118,117,116,115,114,113,113,114,115,117,119,122,125,128,131,133,134,135,134,133,131,129,126,124,121,119,117,116,115,115,115,115,117,118,119,121,122,123,123,123,122,121,119,117,115,114,113,112,113,115,117,120,124,128,131,134,136,138,138,138,136,134,132,129,127,125,123,123,123,124,126,129,132,135,138,141,143,144,145,145,144,143,141,139,138,136,135,135,135,136,137,139,140,141,142,142,142,141,140,140,139,138,139,139,141,143,145,148,150,151,152,152,151,149,147,144,141,137,134,132,130,129,129,129,130,131,132,133,134,135,136,136,136,136,137,137,137,137,137,138,139,139,140,141,141,142,142,143,142,142,141,140,139,138,136,134,132,130,128,127,126,124,124,124,124,124,124,125,126,127,127,128,128,128,129,129,129,130,130,130,131,131,131,132,132,131,131,130,129,127,125,124,121,119,117,115,112,110,108,106,105,104,103,103,104,105,107,109,112,115,118,121,124,126,127,128,127,126,124,122,120,118,116,115,115,116,118,121,124,127,131,133,135,136,135,133,130,125,121,116,112,108,106,105,106,109,112,117,121,126,130,133,134,134,132,130,126,123,120,118,117,118,121,125,130,135,139,143,146,146,144,140,134,127,120,112,106,101,99,100,103,109,116,124,132,139,143,145,144,140,134,125,115,105,96,89,85,85,88,95,105,116,128,140,149,157,160,160,157,150,141,130,120,110,103,98,96,97,102,109,117,126,134,141,146,149,149,146,141,135,128,121,114,109,106,105,106,109,114,120,127,134,139,144,146,147,146,143,140,136,133,131,131,133,137,142,148,154,160,164,166,166,162,156,148,138,128,119,111,106,103,104,107,113,121,130,138,146,152,156,158,158,156,151,146,141,135,131,128,126,127,130,135,141,148,154,160,164,166,166,163,157,149,140,131,123,116,111,109,109,113,118,124,131,136,141,143,143,141,137,132,127,122,118,116,116,118,121,125,130,135,139,142,144,144,142,139,135,131,127,123,120,118,117,117,118,120,123,126,129,131,133,133,131,129,125,120,115,109,105,101,98,97,98,99,103,106,111,115,118,121,123,124,124,124,124,123,124,124,125,127,129,131,132,134,134,134,132,130,127,123,120,116,112,109,107,105,104,105,106,108,110,112,115,116,118,118,118,118,117,116,115,114,114,115,117,119,122,126,129,132,135,136,137,137,136,134,132,130,128,126,125,124,124,123,123,122,121,119,116,114,111,108,106,104,104,105,107,111,116,121,126,131,135,138,140,140,139,136,133,129,126,123,120,119,119,121,123,127,130,134,137,139,140,140,138,135,131,126,122,118,115,113,113,115,118,122,127,132,138,142,146,148,149,148,146,143,140,137,134,132,130,129,130,131,133,135,137,139,140,141,142,142,141,141,140,139,139,140,140,142,144,146,149,151,153,155,155,154,153,150,146,142,137,132,128,124,122,121,121,122,124,128,131,135,138,141,142,142,141,139,136,134,131,129,128,128,129,132,134,138,141,143,145,146,146,144,142,138,134,130,126,122,119,117,116,116,117,119,121,123,125,126,128,128,128,128,127,125,124,122,121,121,121,122,123,125,128,130,133,135,137,138,138,138,136,134,131,128,124,121,119,117,115,114,113,113,113,113,113,114,114,114,114,114,113,113,113,114,114,114,115,116,117,118,120,121,123,124,126,127,129,129,129,128,127,124,122,118,115,112,110,108,107,107,108,110,112,115,118,121,123,125,125,125,124,123,121,119,118,117,117,117,118,119,121,123,125,127,128,129,129,128,127,126,124,122,120,119,119,119,121,123,126,129,133,136,138,140,140,139,136,132,127,122,117,112,108,105,104,104,105,108,111,115,119,122,125,126,127,127,126,125,123,121,120,119,118,118,120,121,124,126,129,131,133,135,135,134,133,130,127,124,121,118,116,115,115,116,119,122,125,129,133,136,138,140,140,139,138,136,133,131,128,126,125,125,125,126,127,129,131,133,134,136,136,136,136,135,135,134,134,135,136,138,141,144,148,151,155,158,159,160,159,157,153,149,145,140,136,132,130,129,129,130,133,136,139,142,145,147,148,149,149,148,147,145,144,143,142,142,142,143,144,146,147,149,151,152,152,153,152,151,150,148,145,142,140,137,135,133,132,131,131,131,131,131,132,132,131,130,129,127,125,124,122,120,119,119,119,120,122,124,126,128,130,132,133,133,133,132,131,129,126,124,121,119,118,117,116,116,117,118,119,120,121,121,121,121,121,120,118,117,116,115,115,115,115,116,118,119,121,123,124,125,126,126,125,123,122,119,117,115,113,111,110,109,109,110,110,112,113,115,116,118,119,121,122,123,124,124,124,124,124,123,122,121,119,117,115,113,111,108,106,103,101,99,97,96,96,96,96,98,100,103,106,109,113,117,120,123,126,128,130,131,132,132,132,131,130,128,126,124,122,120,118,116,115,114,113,113,112,112,113,113,113,113,113,113,112,112,112,112,112,113,114,115,117,119,121,123,125,127,128,130,131,133,134,134,135,136,136,136,135,134,133,132,131,130,128,127,126,125,124,123,123,123,123,124,125,126,127,129,130,132,134,135,137,138,138,139,139,138,138,137,136,135,135,134,134,135,136,137,139,141,143,145,146,148,149,150,150,149,148,146,144,141,138,136,134,132,131,132,133,135,138,141,145,148,151,152,153,153,152,150,148,145,143,142,141,141,142,144,146,149,152,155,158,160,161,162,163,162,161,160,158,156,153,151,147,144,141,137,134,131,129,127,125,125,125,126,128,130,133,136,140,144,148,152,155,158,161,162,163,162,160,157,153,148,142,136,131,125,121,117,115,113,113,113,115,116,118,120,122,123,124,125,125,126,126,126,126,127,128,128,129,130,131,131,131,132,131,131,130,128,127,125,123,120,118,116,115,114,113,113,114,115,117,118,120,121,122,122,122,121,120,119,117,115,114,113,112,111,110,110,109,108,107,105,102,99,97,94,91,88,87,86,86,87,89,92,95,99,104,108,111,114,117,118,118,117,116,113,110,107,104,101,98,96,95,94,95,95,96,97,97,98,97,97,95,94,92,90,88,86,86,86,87,88,91,94,98,102,106,110,114,117,119,121,123,124,126,127,129,131,133,135,138,140,142,143,143,142,139,135,130,124,117,110,103,97,92,90,89,91,94,100,107,115,123,131,138,144,148,151,152,151,150,147,144,141,139,137,136,136,137,138,140,142,144,145,147,147,147,147,146,145,144,144,143,143,144,145,147,150,153,156,159,163,165,167,168,168,166,165,162,159,155,151,147,144,141,139,137,136,137,138,139,141,144,148,151,154,158,161,164,167,169,172,174,176,178,180,181,181,181,180,178,175,170,165,160,154,148,143,138,135,133,132,133,135,138,141,144,148,151,153,155,156,157,157,158,158,158,157,157,157,156,155,154,153,151,150,148,146,145,143,142,140,138,137,135,133,132,130,129,128,127,127,127,127,127,127,127,126,125,124,123,121,120,119,118,118,118,118,119,119,119,119,118,116,114,111,108,105,102,100,98,97,97,97,98,100,101,102,103,104,105,105,105,105,105,105,105,106,106,106,107,107,108,107,107,106,105,104,102,100,98,96,94,93,91,90,89,88,88,88,89,89,90,90,91,91,90,90,90,89,88,88,88,88,89,91,93,95,97,100,102,103,104,105,104,104,103,101,100,99,98,98,99,100,102,103,105,107,109,110,111,111,111,111,110,109,108,107,106,106,105,105,105,105,106,106,106,106,106,106,106,106,107,108,110,113,116,120,124,129,134,139,143,147,149,151,151,150,148,145,141,138,134,131,128,126,125,125,125,126,127,128,129,130,131,132,133,134,136,138,140,143,146,149,152,155,158,160,162,163,163,162,161,159,157,155,152,151,149,148,147,147,147,147,147,148,148,148,148,148,148,147,148,148,149,150,151,153,155,157,159,161,163,164,165,166,166,165,164,162,160,157,154,152,149,146,144,142,140,140,139,140,140,141,143,144,146,147,148,149,150,151,151,151,151,151,151,151,152,152,152,152,152,152,151,150,149,148,146,145,143,141,140,138,137,136,134,133,132,131,130,129,128,127,126,126,126,127,127,128,130,131,133,135,137,139,141,143,144,145,146,146,146,145,144,143,142,140,138,135,133,130,128,126,124,122,121,120,120,120,121,122,124,127,129,132,134,137,138,139,140,139,138,136,134,131,128,125,123,120,119,117,117,116,116,116,117,117,118,118,119,119,120,121,122,123,124,125,125,125,125,124,123,121,118,114,111,106,102,98,93,89,86,83,80,78,76,75,74,74,75,75,76,77,79,81,83,86,89,92,95,98,101,104,107,109,110,111,110,109,107,104,101,98,95,92,89,87,86,85,85,86,87,88,89,91,92,93,95,96,97,98,99,100,101,103,104,106,107,108,109,109,110,110,110,110,110,110,110,111,112,114,116,118,121,123,126,128,129,129,129,128,126,123,120,117,113,111,108,107,106,106,108,109,111,113,115,116,117,118,118,117,117,117,117,117,118,120,123,127,131];

function cancelAnalyserUpdates() {
    window.cancelAnimationFrame( rafID );
    rafID = null;
}

var countI=0;
function updateAnalysers(time) {
    {
        var freqData = new Uint8Array(2048);
        analyserNode.getByteTimeDomainData(freqData);
       var frekvence = testRealTime(freqData);
       //if(countI++%10 === 0 )
          //console.log(testRealTime(freqData));
       if(countI++%100 === 0 ) 
           //while (countI++ > 50 && countI<100 ) 
               console.log(joinArr(freqData), frekvence);
          // drawGraph(normalizeTimeData3(freqData));
        //if(countI++%100 === 0 ) console.log(testRealTime(freqData), joinArr(normalizeTimeData3(freqData)));
        var FreqElem = document.getElementById('frequency');
        //var NoteElem = document.getElementById('note');
        
        FreqElem.innerText=frekvence;
        //Note = freqnote(autoCorrelate(freqData));
        //NoteElem.innerText=Note.step + Note.oct;
        //drawData(freqData); 
        

    }    
    rafID = window.requestAnimationFrame( updateAnalysers );
}

function joinArr(buff){
    var txt = '';
    for(var i=0, l=buff.length; i<l; i++){
        txt +=  buff[i]+',';
    }
    return txt;
}

function getPitch(data){
    if(!logPitch) return;
    var max = { i: 0, val: 0 };
    for(var i=5, l=data.length; i<l; i++){
        if(max.val < data[i]) {
            max.i = i;
            max.val = data[i];
        }
    }
    console.log(max.i, max.val);
}

function test(data) {
    console.log(data);
}

/*function windowing (buf){
    var gauswin=[];
    for(var i=0, l=2048; i<l; i++)
        {
            gauswin[i]=Math.pow(Math.E, -0.5*(Math.pow((i-(l-1)/2)/(0.5*(l-1)/2), 2)));
}
        return gauswin;
}*/

/*function drawGraph(buf){
    var canvas = document.getElementById("graph");
        canvasWidth = canvas.width;
        canvasHeight = canvas.height;
        analyserContext = canvas.getContext('2d');
        
    for(var i=0, l=buf.length; i<l; i++){
        analyserContext.moveTo(i,500);
        analyserContext.lineTo(i,500-500*buf[i]);
    }
}*/

function drawData(freqData){
    if (!analyserContext) {
        var canvas = document.getElementById("graph");
        canvasWidth = canvas.width;
        canvasHeight = canvas.height;
        analyserContext = canvas.getContext('2d');
    }
    analyserContext.clearRect(0, 0, canvasWidth, canvasHeight);
    if (freqData[50]===freqData[100]) analyserContext.fillRect(75, 20, 10, 10);
    if (freqData[50]===0) analyserContext.fillRect(100, 20, 10, 10);
   for (var i = 0; i < freqData.length; i++) {
            var value = freqData[i] / 256;
            var y = canvasHeight - (canvasHeight * value) - 1;
            analyserContext.fillStyle = 'black';
            analyserContext.fillRect(i, y, 1, 3);
        }
    //analyserContext.fillRect(canvasWidth-30, canvasHeight, 30, -testRealTime(freqData) );
        }
    
/*function autoCorrelate(buf) {
	var MIN_SAMPLES = 100;	// corresponds to an 11kHz signal
	var MAX_SAMPLES = 1024; // corresponds to a 44Hz signal
	var SIZE = 1024;
	var best_offset = -1;
	var best_correlation = 0;
	var rms = 0;
        
        
	if (buf.length < (SIZE + MAX_SAMPLES - MIN_SAMPLES))
		return;  // Not enough data

	for (var i=0;i<SIZE;i++) {
		var val = (buf[i] - 128)/128;
		rms += val*val;
	} 
	rms = Math.sqrt(rms/SIZE);
       
	for (var offset = MIN_SAMPLES; offset <= MAX_SAMPLES; offset++) {
		var correlation = 0;

		for (var i=0; i<SIZE; i++) {
			correlation += Math.abs(((buf[i] - 128)/128)-((buf[i+offset] - 128)/128));
		}
		correlation = 1 - (correlation/SIZE);
		if (correlation > best_correlation) {
			best_correlation = correlation;
			best_offset = offset;
		}
	}
	if ((rms>0.01)&&(best_correlation > 0.01)) {
		return audioContext.sampleRate/best_offset;
	}
        
}*/

function freqnote(freq){
    
    var note;
    var oct;
    var step;
    var diff=12*Math.log(freq/440)/Math.log(2);
    diff=Math.round(diff);
    
    note=58+diff;
    oct=Math.floor(note/12);
    note%=12;

    switch(note)
    {
        case 1: {step='C'; break;}
        case 2: {step='C♯/D♭'; break;}
        case 3: {step='D'; break;}
        case 4: {step='D♯/E♭'; break;}
        case 5: {step='E'; break;}
        case 6: {step='F'; break;}
        case 7: {step='F♯/G♭'; break;}
        case 8: {step='G'; break;}
        case 9: {step='G♯/A♭'; break;}
        case 10: {step='A'; break;}
        case 11: {step='A♯/B♭'; break;}
        case 0: {step='B'; oct--; break;}
    }
    return {step:step, oct:oct, note:note};
}

function gotStream(stream) {
    inputPoint = audioContext.createGain();

    
    audioInput = audioContext.createMediaStreamSource(stream);
    audioInput.connect(inputPoint);

    analyserNode = audioContext.createAnalyser();
    analyserNode.fftSize = 2048;
    analyserNode.smoothingTimeConstant = 1;
    inputPoint.connect( analyserNode );

    zeroGain = audioContext.createGain();
    zeroGain.gain.value = 0.0;
    inputPoint.connect( zeroGain );
    zeroGain.connect( audioContext.destination );
    updateAnalysers();
}

function initAudio() {
        if (!navigator.getUserMedia)
            navigator.getUserMedia = navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
        if (!navigator.cancelAnimationFrame)
            navigator.cancelAnimationFrame = navigator.webkitCancelAnimationFrame || navigator.mozCancelAnimationFrame;
        if (!navigator.requestAnimationFrame)
            navigator.requestAnimationFrame = navigator.webkitRequestAnimationFrame || navigator.mozRequestAnimationFrame;

    navigator.getUserMedia({audio:true}, gotStream, function(e) {
            alert('Error getting audio');
            console.log(e);
        });
}

window.addEventListener('load', initAudio );

